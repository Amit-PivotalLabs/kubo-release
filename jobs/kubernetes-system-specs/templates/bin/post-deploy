#!/usr/bin/env bash

spec_dir="/var/vcap/jobs/kubernetes-system-specs/config/"
kubectl="/var/vcap/packages/kubernetes/bin/kubectl --kubeconfig=/var/vcap/jobs/kubeconfig/config/kubeconfig"

TIMEOUT=120

apply_spec() {
  local spec="$1"
  ${kubectl} apply -f "${spec_dir}/${spec}" || echo "${spec} was already deployed"
}

deploy_specs() {
  apply_spec "kubedns-svc.yml"
  apply_spec "kubedns-controller.yml"
  apply_spec "influxdb.yml"
  apply_spec "heapster.yml"
  apply_spec "kubernetes-dashboard.yml"
}

verify_specs() {
  if timeout "$TIMEOUT" /var/vcap/jobs/kubernetes-system-specs/bin/ensure-specs-running
  then
    echo "all expected specs are running"
  else
    echo "failed to start all system specs after $TIMEOUT with exit code $?"
    exit 1
  fi
}

main() {

  export HTTP_PROXY=10.0.252.2:8888
  export http_proxy=10.0.252.2:8888
  export HTTPS_PROXY=10.0.252.2:8888
  export https_proxy=10.0.252.2:8888

  export no_proxy='10.200.0.0,10.200.0.1,10.200.0.2,10.200.0.3,10.200.0.4,10.200.0.5,10.200.0.6,10.200.0.7,10.200.0.8,10.200.0.9,10.200.0.10,10.200.0.11,10.200.0.12,10.200.0.13,10.200.0.14,10.200.0.15,10.200.0.16,10.200.0.17,10.200.0.18,10.200.0.19,10.200.0.20,10.200.0.21,10.200.0.22,10.200.0.23,10.200.0.24,10.200.0.25,10.200.0.26,10.200.0.27,10.200.0.28,10.200.0.29,10.200.0.30,10.200.0.31,10.200.0.32,10.200.0.33,10.200.0.34,10.200.0.35,10.200.0.36,10.200.0.37,10.200.0.38,10.200.0.39,10.200.0.40,10.200.0.41,10.200.0.42,10.200.0.43,10.200.0.44,10.200.0.45,10.200.0.46,10.200.0.47,10.200.0.48,10.200.0.49,10.200.0.50,10.200.0.51,10.200.0.52,10.200.0.53,10.200.0.54,10.200.0.55,10.200.0.56,10.200.0.57,10.200.0.58,10.200.0.59,10.200.0.60,10.200.0.61,10.200.0.62,10.200.0.63' 
  export NO_PROXY='10.200.0.0,10.200.0.1,10.200.0.2,10.200.0.3,10.200.0.4,10.200.0.5,10.200.0.6,10.200.0.7,10.200.0.8,10.200.0.9,10.200.0.10,10.200.0.11,10.200.0.12,10.200.0.13,10.200.0.14,10.200.0.15,10.200.0.16,10.200.0.17,10.200.0.18,10.200.0.19,10.200.0.20,10.200.0.21,10.200.0.22,10.200.0.23,10.200.0.24,10.200.0.25,10.200.0.26,10.200.0.27,10.200.0.28,10.200.0.29,10.200.0.30,10.200.0.31,10.200.0.32,10.200.0.33,10.200.0.34,10.200.0.35,10.200.0.36,10.200.0.37,10.200.0.38,10.200.0.39,10.200.0.40,10.200.0.41,10.200.0.42,10.200.0.43,10.200.0.44,10.200.0.45,10.200.0.46,10.200.0.47,10.200.0.48,10.200.0.49,10.200.0.50,10.200.0.51,10.200.0.52,10.200.0.53,10.200.0.54,10.200.0.55,10.200.0.56,10.200.0.57,10.200.0.58,10.200.0.59,10.200.0.60,10.200.0.61,10.200.0.62,10.200.0.63'




  deploy_specs
  verify_specs
}

main
